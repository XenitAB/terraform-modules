name: Update terraform dependencies
on:
  workflow_dispatch:
  schedule:
    - cron:  '0 6 * * *'
jobs:
  tf-latest-version:
    runs-on: ubuntu-latest
    steps:
      - name: Setup tf-latest-version
        env:
          TF_LATEST_VERSION_VERSION: "0.0.3"
          TF_LATEST_VERSION_SHA: "85428a3d1494dda2921344e1b7c11266ea0285a3bbe2f57397625c12533895ee"
        run: |
          set -e
          wget https://github.com/XenitAB/tf-latest-version/releases/download/v${TF_LATEST_VERSION_VERSION}/tf-latest-version_${TF_LATEST_VERSION_VERSION}_linux_amd64.tar.gz
          DOWNLOAD_TF_LATEST_VERSION_SHA=$(openssl sha1 -sha256 tf-latest-version_${TF_LATEST_VERSION_VERSION}_linux_amd64.tar.gz | awk '{print $2}')
          if [[ "${TF_LATEST_VERSION_SHA}" != "${DOWNLOAD_TF_LATEST_VERSION_SHA}" ]]; then
              echo "Downloaded checksum (${DOWNLOAD_TF_LATEST_VERSION_SHA}) for tf-latest-version does not match expected value: ${TF_LATEST_VERSION_SHA}"
              exit 1
          fi
          tar xzvf tf-latest-version_${TF_LATEST_VERSION_VERSION}_linux_amd64.tar.gz
          rm tf-latest-version_${TF_LATEST_VERSION_VERSION}_linux_amd64.tar.gz
          mkdir -p ~/.local/bin/
          mv ./tf-latest-version ~/.local/bin/tf-latest-version

      - name: Checkout
        uses: actions/checkout@v2

      - name: Run tf-latest-version
        run: |
          set -xe
          export PATH=${PATH}:~/.local/bin
          CURRENT_DIR=$(pwd)
          MODULE_GROUPS=$(find modules -mindepth 1 -maxdepth 1 -type d)
          for MODULE_GROUP in ${MODULE_GROUPS}; do
            MODULES=$(find ${MODULE_GROUP} -mindepth 1 -maxdepth 1 -type d)
            for MODULE in $MODULES; do
              tf-latest-version ${CURRENT_DIR}/${MODULE}
            done
          done

      - name: Setup terraform-docs
        env:
          TERRAFORM_DOCS_VERSION: "v0.11.2"
          TERRAFORM_DOCS_SHA: "0d1e42d6fcb15b14027ae8efb794edb1cd7faa7a32507ccad449340529d04937"
        run: |
          curl -Lo ./terraform-docs https://github.com/terraform-docs/terraform-docs/releases/download/${TERRAFORM_DOCS_VERSION}/terraform-docs-${TERRAFORM_DOCS_VERSION}-$(uname | tr '[:upper:]' '[:lower:]')-amd64
          DOWNLOAD_TERRAFORM_DOCS_SHA=$(openssl sha1 -sha256 terraform-docs | awk '{print $2}')
          if [[ "${TERRAFORM_DOCS_SHA}" != "${DOWNLOAD_TERRAFORM_DOCS_SHA}" ]]; then
              echo "Downloaded checksum (${DOWNLOAD_TERRAFORM_DOCS_SHA}) for terraform-docs does not match expected value: ${TERRAFORM_DOCS_SHA}"
              exit 1
          fi
          chmod +x ./terraform-docs
          mkdir -p ~/.local/bin/
          mv ./terraform-docs ~/.local/bin/terraform-docs
      - name: Run docs
        run: |
          export PATH=${PATH}:~/.local/bin
          make docs

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          committer: GitHub <noreply@github.com>
          commit-message: Update versions
          title: Update Terraform Provider and Helm Chart versions
          body: |
            Update Terraform Provider and Helm Chart versions.

            Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          delete-branch: true
          branch: update/terraform-versions
          labels: |
            automation

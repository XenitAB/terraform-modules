---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt
spec:
  acme:
    email: {{ .Values.notificationEmail }}
    server: {{ .Values.acmeServer }}
    privateKeySecretRef:
      name: letsencrypt-cluster-issuer-account-key
    solvers:
    {{- if eq .Values.cloudProvider "azure" }}
    {{- range $zone := $.Values.azureConfig.hostedZoneNames }}
    - selector:
        dnsZones:
          - {{ . | quote }}
      dns01:
          azureDNS:
            environment: AzurePublicCloud
            subscriptionID: {{ $.Values.azureConfig.subscriptionID }}
            resourceGroupName: {{ $.Values.azureConfig.resourceGroupName }}
            hostedZoneName: {{ . | quote }}
            managedIdentity:
              clientID: {{ $.Values.azureConfig.clientID }}
    {{- end }}
    {{- end }}
    {{- if eq .Values.cloudProvider "aws" }}
    {{- range $key, $val := $.Values.awsConfig.zones }}
    - selector:
        dnsZones:
          - {{ $val.name | quote }}
      dns01:
        route53:
          region: {{ $.Values.awsConfig.region }}
          hostedZoneID: {{ $val.hostedZoneID | quote }}
    {{- end }}
    {{- end }}
